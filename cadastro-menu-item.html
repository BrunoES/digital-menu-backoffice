<html>
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
        <title>Cadastro de Itens </title>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script type="text/javascript" src="./tabela.js"></script>
        <script type="text/javascript">
            const ENDPOINT = 'http://localhost:8080/menu-items';
            const DEFAULT_IMG = "./imgs/slider-icon.png";
            const MSG_FORM_ERROR = "Preencha todos os campos do produto.";
            const MSG_SUCCESS_SAVE = "Produto salvo com sucesso";
            const MSG_SUCCESS_CHANGE = "Produto alterado com sucesso";
            const MSG_SUCCESS_DELETE = "Produto deletado com sucesso";
            const TIMEOUT_MSG_DANGER = 4500;
            const TIMEOUT_MSG_SUCCESS = 3000;
            const MSG_TYPE_SUCCESS = 'success';
            const MSG_TYPE_DANGER = 'danger';

            var sequence = 0;            
            var pessoas = [];
            var base64Imgs = [];

            var loadPreview = function(event) {
                var output = document.getElementById('productImage');
                output.src = URL.createObjectURL(event.target.files[0]);
            };

            function init() {
                getProdutos();
            }

            function alertMessage(type, message, timeout) {
                const wrapper = document.createElement('div');

                wrapper.innerHTML = [
                    `<div class="alert alert-${type} alert-dismissible" role="alert">`,
                    `<span class="fs-5">${message}</span>`,
                    '</div>'
                ].join('')

                document.getElementById('liveAlertPlaceholder').append(wrapper)

                setTimeout(function () {
                    document.getElementById('liveAlertPlaceholder').innerHTML = "";
                }, timeout);
            }

            var maskPrice = function(event) {
                const defaultValue = '000.00';
                var value = event.target.value.replace(".", "");
                var formattedValue = parseFloat(value / 100).toFixed(2);
                
                if(formattedValue.length > 6) {
                    formattedValue = parseFloat(formattedValue / 10).toFixed(2);
                }

                document.getElementById('price').value = formattedValue;
            };

            const formatter = new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
            });

            function save() {
                var id = document.getElementById('id').value;
                var name = document.getElementById('name').value;
                var description = document.getElementById('description').value;
                var price = document.getElementById('price').value;
                var photo = document.getElementById('photo').files[0];

                console.log("id: " + id);

                if(id == "") {
                    saveNewItem(photo, name, description, price);
                } else {
                    editExistingItem(photo, id, name, description, price);
                }
            }

            function saveNewItem(photo, name, description, price) {
                if(photo !== undefined) {
                    var reader = new FileReader();
                    var imgType = photo.type;
                    var base64Img = "";

                    reader.readAsDataURL(photo);
                    reader.onload = function () {
                        base64Img =  reader.result;

                        if(name != "" && description != "" && price != "" && base64Img != "") {
                            var image = {
                                base64: base64Img,
                                type: imgType
                            };
                            callPost(id, name, description, price, image);
                        } else {
                            alertMessage(MSG_TYPE_DANGER, MSG_FORM_ERROR, TIMEOUT_MSG_DANGER);
                        }
                    };
                } else {
                    alertMessage(MSG_TYPE_DANGER, MSG_FORM_ERROR, TIMEOUT_MSG_DANGER);
                }
            }

            function editExistingItem(photo, id, name, description, price) {
                if(name != "" && description != "" && price != "") {
                    if(photo !== undefined) {
                        var reader = new FileReader();
                        var imgType = photo.type;
                        reader.readAsDataURL(photo);

                        reader.onload = function () {
                            var image = {
                                base64: reader.result,
                                type: imgType
                            };
                            callPut(id, name, description, price, image);
                        };
                    } else {
                        var image = {
                                base64: "",
                                type: ""
                            };
                        callPut(id, name, description, price, image);
                    }
                } else {
                    alertMessage(MSG_TYPE_DANGER, MSG_FORM_ERROR, TIMEOUT_MSG_DANGER);
                }
            }

            function callPost(id, name, description, price, image) {
                axios.post(ENDPOINT, {
                        name,
                        description,
                        price,
                        image
                    })
                    .then(function (response) {
                        console.log(response);
                        alertMessage(MSG_TYPE_SUCCESS, MSG_SUCCESS_SAVE, TIMEOUT_MSG_SUCCESS);
                        cleanForm();
                        getProdutos();
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            }

            function callPut(id, name, description, price, image) {
                axios.put(ENDPOINT, {
                        id,
                        name,
                        description,
                        price,
                        image
                    })
                    .then(function (response) {
                        console.log(response);
                        alertMessage(MSG_TYPE_SUCCESS, MSG_SUCCESS_CHANGE, TIMEOUT_MSG_SUCCESS);
                        cleanForm();
                        getProdutos();
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            }

            function getBase64(file) {
                var reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function () {
                    console.log(reader.result);
                    return reader.result;
                };
                reader.onerror = function (error) {
                    console.log('Error: ', error);
                };
            }

            function deleteProduct(id) {
                axios.delete(`${ENDPOINT}/${id}`)
                    .then(function (response) {
                        console.dir(response);
                        alertMessage(MSG_TYPE_DANGER, MSG_SUCCESS_DELETE, TIMEOUT_MSG_DANGER);
                        cleanForm();
                        getProdutos();
                    })
                    .catch(function (error) {
                        console.log(error);
                    })
                    .finally(function () {
                    });
            }

            function editProduct(id, name, description, price) {
                cleanForm();
                document.getElementById('id').value = id;
                document.getElementById('name').value = name;
                document.getElementById('description').value = description;
                document.getElementById('price').value = price;
                document.getElementById('productImage').src = `data:image/png;base64,${base64Imgs[id]}`;
                document.getElementById('name').focus();
            }

            function cleanForm() {
                console.log(formatter.format(2500));
                document.getElementById('id').value = "";
                document.getElementById('name').value = "";
                document.getElementById('description').value = "";
                document.getElementById('price').value = "";
                document.getElementById('photo').value = "";
                document.getElementById('productImage').src = DEFAULT_IMG;
                document.getElementById('name').focus();
            }

            function getProdutos() {
                limpaTabela();

                axios.get(ENDPOINT)
                    .then(function (response) {
                        var menuItems = response.data;
                        console.dir(menuItems);
                        base64Imgs = [];
                        menuItems.forEach(element => {
                            var item = element.menuItem;
                            insertProductTable(item.id, item.name, item.description, item.price);
                            base64Imgs[item.id] = element.base64Img;
                            console.log();
                        });
                    })
                    .catch(function (error) {
                        console.log(error);
                    })
                    .finally(function () {
                    });
            }

            function limpaTabela() {
                var tableHeaderRowCount = 1;
                var table = document.getElementById("product_table");
                var rowCount = table.rows.length;
                for (var i = tableHeaderRowCount; i < rowCount; i++) {
                    table.deleteRow(tableHeaderRowCount);
                }
            }
        </script>
    </head>
    <body onload="init()">
        <div class="form-group m-5">
                <h1>Cadastro de Itens</h1>
                <label for="id">ID:</label>
                <input type="number" class="form-control" id="id" readonly/>
                <br>
                <label for="nome">Nome do Item:</label>
                <input type="text" class="form-control" id="name" maxlength="60"/>
                <br>
                <label for="description">Descrição do Item:</label>
                <textarea class="form-control" id="description" maxlength="255"></textarea>
                <br>
                <label for="price">Preço:</label>
                <input type="number" class="form-control" id="price" oninput="maskPrice(event)"/>
                <br>
                <label for="photo">Foto do Produto:</label>
                <input type="file" class="form-control-file" id="photo" accept="image/jpeg, image/png, image/jpg" onchange="loadPreview(event)">
                <br>
                <img id="productImage" class="rounded float-left w-25 mt-3" alt="Responsive image" src="./imgs/slider-icon.png"></img>
                <br>
                <br>
                <div id="liveAlertPlaceholder" class="fixed-bottom">
                </div>
                <button type="button" class="btn btn-success" onclick="save();">Salvar</button>
                <button type="button" class="btn btn-primary" onclick="getProdutos();">Consultar</button>
                <button type="button" class="btn btn-warning" onclick="cleanForm();">Novo</button>

            <br>
            <div class="overflow-auto h-50">
                <table class="table m-4" id="product_table">
                    <thead>
                        <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Nome</th>
                        <th scope="col">Descrição</th>
                        <th scope="col">Preço</th>
                        <th scope="col">Excluir</th>
                        <th scope="col">Editar</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </body>
</html>