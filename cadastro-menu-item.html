<html>
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
        <title>Cadastro de Itens </title>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script type="text/javascript" src="./table.js"></script>
        <script type="text/javascript">
            const ENDPOINT = 'http://192.168.0.18:8080/menu-items';
            const DEFAULT_IMG = "./imgs/slider-icon.png";
            const MSG_FORM_ERROR = "Preencha todos os campos do produto.";
            const MSG_SUCCESS_SAVE = "Produto salvo com sucesso";
            const MSG_SUCCESS_CHANGE = "Produto alterado com sucesso";
            const MSG_SUCCESS_DELETE = "Produto deletado com sucesso";
            const MSG_DIALOG_DELETE = "Tem certeza que deseja deletar este produto?";
            const TIMEOUT_MSG_DANGER = 4500;
            const TIMEOUT_MSG_SUCCESS = 3000;
            const TIMEOUT_MSG_DIALOG = 10000;
            const MSG_TYPE_SUCCESS = 'success';
            const MSG_TYPE_DANGER = 'danger';
            const MSG_TYPE_WARNING = 'warning';

            var sequence = 0;            
            var pessoas = [];
            var base64Imgs = [];

            function init() {
                getProdutos();
            }

            // -- Formatting
            const formatter = new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
            });

            function formatPrice(price) {
                return "R$ " + parseFloat(price).toFixed(2).replace(".", ",");
            }

            function cleanPrice(price) {
                return price.replace("R$ ", "").replace(",", ".");
            }

            var loadPreview = function(event) {
                var output = document.getElementById('productImage');
                output.src = URL.createObjectURL(event.target.files[0]);
            };

            var maskPrice = function(event) {
                const defaultValue = '000.00';
                var value = event.target.value.replace(".", "");
                var formattedValue = parseFloat(value / 100).toFixed(2);
                
                if(formattedValue.length > 6) {
                    formattedValue = parseFloat(formattedValue / 10).toFixed(2);
                }

                document.getElementById('price').value = formattedValue;
            };

            // -- Alert & Dialogs
            function closeAlerts() {
                document.getElementById('liveAlertPlaceholder').innerHTML = "";
            }

            function closeDialogs() {
                document.getElementById('liveDialogPlaceholder').innerHTML = "";
            }

            function alertMessage(type, message, timeout) {
                closeAlerts();
                closeDialogs();

                const wrapper = document.createElement('div');

                wrapper.innerHTML = [
                    `<div class="alert alert-${type} alert-dismissible" role="alert">`,
                    `<span class="fs-5">${message}</span>`,
                    '</div>'
                ].join('')

                document.getElementById('liveAlertPlaceholder').append(wrapper)

                setTimeout(function () {
                    closeAlerts();
                }, timeout);
            }

            function confirmDialog(type, message, timeout, confirmationFunction) {
                closeAlerts();
                closeDialogs();

                const wrapper = document.createElement('div');

                wrapper.innerHTML = [
                    `<div class="alert alert-${type} alert-dismissible" role="alert">`,
                    `<span class="fs-5">${message}</span>  `,
                    `  <button type="button" class="btn btn-success" onclick="closeDialogs();${confirmationFunction}">Sim</button>`,
                    `  <button type="button" class="btn btn-danger" onclick="closeDialogs();">NÃ£o</button>`,
                    '</div>'
                ].join('')

                document.getElementById('liveDialogPlaceholder').append(wrapper)

                setTimeout(function () {
                    closeDialogs();
                }, timeout);
            }

            // -- CRUD API 
            function save() {
                var id = document.getElementById('id').value;
                var name = document.getElementById('name').value;
                var description = document.getElementById('description').value;
                var price = document.getElementById('price').value;
                var photo = document.getElementById('photo').files[0];

                console.log("id: " + id);

                if(id == "") {
                    saveNewItem(photo, name, description, price);
                } else {
                    editExistingItem(photo, id, name, description, price);
                }
            }

            function saveNewItem(photo, name, description, price) {
                if(photo !== undefined) {
                    var reader = new FileReader();
                    var imgType = photo.type;
                    var base64Img = "";

                    reader.readAsDataURL(photo);
                    reader.onload = function () {
                        base64Img =  reader.result;

                        if(name != "" && description != "" && price != "" && base64Img != "") {
                            var image = {
                                base64: base64Img,
                                type: imgType
                            };
                            callPost(id, name, description, price, image);
                        } else {
                            alertMessage(MSG_TYPE_DANGER, MSG_FORM_ERROR, TIMEOUT_MSG_DANGER);
                        }
                    };
                } else {
                    alertMessage(MSG_TYPE_DANGER, MSG_FORM_ERROR, TIMEOUT_MSG_DANGER);
                }
            }

            function editExistingItem(photo, id, name, description, price) {
                if(name != "" && description != "" && price != "") {
                    if(photo !== undefined) {
                        var reader = new FileReader();
                        var imgType = photo.type;
                        reader.readAsDataURL(photo);

                        reader.onload = function () {
                            var image = {
                                base64: reader.result,
                                type: imgType
                            };
                            callPut(id, name, description, price, image);
                        };
                    } else {
                        var image = {
                                base64: "",
                                type: ""
                            };
                        callPut(id, name, description, price, image);
                    }
                } else {
                    alertMessage(MSG_TYPE_DANGER, MSG_FORM_ERROR, TIMEOUT_MSG_DANGER);
                }
            }

            function callPost(id, name, description, price, image) {
                axios.post(ENDPOINT, {
                        name,
                        description,
                        price,
                        image
                    })
                    .then(function (response) {
                        console.log(response);
                        alertMessage(MSG_TYPE_SUCCESS, MSG_SUCCESS_SAVE, TIMEOUT_MSG_SUCCESS);
                        cleanForm();
                        getProdutos();
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            }

            function callPut(id, name, description, price, image) {
                axios.put(ENDPOINT, {
                        id,
                        name,
                        description,
                        price,
                        image
                    })
                    .then(function (response) {
                        console.log(response);
                        alertMessage(MSG_TYPE_SUCCESS, MSG_SUCCESS_CHANGE, TIMEOUT_MSG_SUCCESS);
                        cleanForm();
                        getProdutos();
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            }

            function getBase64(file) {
                var reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function () {
                    console.log(reader.result);
                    return reader.result;
                };
                reader.onerror = function (error) {
                    console.log('Error: ', error);
                };
            }

            function onClickDelete(id) {
                confirmDialog(MSG_TYPE_WARNING, MSG_DIALOG_DELETE, TIMEOUT_MSG_DIALOG, `deleteProduct(${id});`);
            }

            function deleteProduct(id) {
                axios.delete(`${ENDPOINT}/${id}`)
                    .then(function (response) {
                        console.dir(response);
                        alertMessage(MSG_TYPE_DANGER, MSG_SUCCESS_DELETE, TIMEOUT_MSG_DANGER);
                        cleanForm();
                        getProdutos();
                    })
                    .catch(function (error) {
                        console.log(error);
                    })
                    .finally(function () {
                    });
            }

            function getProdutos() {
                cleanTable();

                axios.get(ENDPOINT)
                    .then(function (response) {
                        var menuItems = response.data;
                        console.dir(menuItems);
                        base64Imgs = [];
                        menuItems.forEach(element => {
                            var item = element.menuItem;
                            insertProductTable(item.id, item.name, item.description, formatPrice(item.price));
                            base64Imgs[item.id] = element.base64Img;
                            console.log();
                        });
                    })
                    .catch(function (error) {
                        console.log(error);
                    })
                    .finally(function () {
                    });
            }

            // -- Form Controll
            function editProduct(id, name, description, price) {
                cleanForm();
                document.getElementById('id').value = id;
                document.getElementById('name').value = name;
                document.getElementById('description').value = description;
                document.getElementById('price').value = price;
                document.getElementById('productImage').src = `data:image/png;base64,${base64Imgs[id]}`;
                document.getElementById('name').focus();
            }

            function cleanForm() {
                document.getElementById('id').value = "";
                document.getElementById('name').value = "";
                document.getElementById('description').value = "";
                document.getElementById('price').value = "";
                document.getElementById('photo').value = "";
                document.getElementById('productImage').src = DEFAULT_IMG;
                document.getElementById('name').focus();
            }

            function cleanTable() {
                var tableHeaderRowCount = 1;
                var table = document.getElementById("product_table");
                var rowCount = table.rows.length;
                for (var i = tableHeaderRowCount; i < rowCount; i++) {
                    table.deleteRow(tableHeaderRowCount);
                }
            }
        </script>
    </head>
    <body onload="init()">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #ff6219;">
        <!-- Container wrapper -->
        <div class="container-fluid">
          <!-- Toggle button -->
          <button
            class="navbar-toggler"
            type="button"
            data-mdb-toggle="collapse"
            data-mdb-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <i class="fas fa-bars"></i>
          </button>

          <!-- Collapsible wrapper -->
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <!-- Navbar brand -->
            <a class="navbar-brand mt-2 mt-lg-0" href="#">
              <img
                src="https://mdbcdn.b-cdn.net/img/logo/mdb-transaprent-noshadows.webp"
                height="15"
                alt="MDB Logo"
                loading="lazy"
              />
            </a>
            <!-- Left links -->
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link lg-4" style="color: white" href="./cadastro-menu-item.html">Produtos</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" style="color: white" href="#">Mesas</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" style="color: white" href="#">Minha conta</a>
              </li>
            </ul>
            <!-- Left links -->
          </div>
          <!-- Collapsible wrapper -->

          <!-- Right elements -->
          <div class="d-flex align-items-center">
            <!-- Icon -->
            <a class="text-reset me-3" href="#">
              <i class="fas fa-shopping-cart"></i>
            </a>

            <!-- Notifications -->
            <div class="dropdown">
              <a
                class="text-reset me-3 dropdown-toggle hidden-arrow"
                href="#"
                id="navbarDropdownMenuLink"
                role="button"
                data-mdb-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="fas fa-bell"></i>
                <span class="badge rounded-pill badge-notification bg-danger">1</span>
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="navbarDropdownMenuLink"
              >
                <li>
                  <a class="dropdown-item" href="#">Some news</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">Another news</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">Something else here</a>
                </li>
              </ul>
            </div>
            <!-- Avatar -->
            <div class="dropdown">
              <a
                class="dropdown-toggle d-flex align-items-center hidden-arrow"
                href="#"
                id="navbarDropdownMenuAvatar"
                role="button"
                data-mdb-toggle="dropdown"
                aria-expanded="false"
              >
                <img
                  src="https://mdbcdn.b-cdn.net/img/new/avatars/2.webp"
                  class="rounded-circle"
                  height="25"
                  alt="Black and White Portrait of a Man"
                  loading="lazy"
                />
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="navbarDropdownMenuAvatar"
              >
                <li>
                  <a class="dropdown-item" href="#">My profile</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">Settings</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">Logout</a>
                </li>
              </ul>
            </div>
          </div>
          <!-- Right elements -->
        </div>
        <!-- Container wrapper -->
      </nav>
      <!-- Navbar -->
        <div class="form-group m-4">
            <h2>Cadastro de Itens</h2>
            <input type="number" class="form-control m-2" id="id" placeholder="CÃ³digo" readonly/>
            <input type="text" class="form-control m-2" id="name" placeholder="Nome do Produto" maxlength="60"/>
            <textarea class="form-control m-2" id="description" maxlength="255" placeholder="DescriÃ§Ã£o"></textarea>
            <input type="number" class="form-control m-2" id="price" placeholder="PreÃ§o R$" oninput="maskPrice(event)"/>
            
            <div class="container m-1">
                <div class="row">
                    <div class="col-sm">
                        <label for="photo">Foto do Produto:</label>
                        <input type="file" class="form-control" id="photo" placeholder="Selecione uma foto para o produto" accept="image/jpeg, image/png, image/jpg" onchange="loadPreview(event)">
                    </div>
                    <div class="col-sm">
                        <img id="productImage" class="rounded float-left w-25" alt="Responsive image" src="./imgs/slider-icon.png"></img>            
                    </div>  
                </div>
            </div>
            <div class="m-1">
                <button type="button" class="btn btn-success" onclick="save();">Salvar</button>
                <button type="button" class="btn btn-primary" onclick="getProdutos();">Consultar</button>
                <button type="button" class="btn btn-warning" onclick="cleanForm();">Novo</button>
            </div>
            <div id="liveAlertPlaceholder" class="fixed-bottom">
            </div>
            <div id="liveDialogPlaceholder" class="fixed-bottom">
            </div>
            <br/>
            <div class="overflow-auto h-50">
                <table class="table m-4" id="product_table">
                    <thead>
                        <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Nome</th>
                        <th scope="col">DescriÃ§Ã£o</th>
                        <th scope="col">PreÃ§o</th>
                        <th scope="col">Excluir</th>
                        <th scope="col">Editar</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </body>
</html>